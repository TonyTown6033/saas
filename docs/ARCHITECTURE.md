# 架构设计文档

## 系统架构概览

### 整体架构图

```
┌──────────────────────────────────────────────────────────┐
│                    前端层 (Vue Admin)                     │
│  - 管理后台                                               │
│  - 服务管理界面                                           │
│  - 用户管理                                               │
└────────────────────┬─────────────────────────────────────┘
                     │ HTTP/HTTPS
┌────────────────────▼─────────────────────────────────────┐
│                  API 网关 (Gateway)                       │
│  - 统一入口                                               │
│  - 动态路由                                               │
│  - 请求转发                                               │
│  - 负载均衡                                               │
└──┬───────────────────┬──────────────────────┬────────────┘
   │                   │                      │
   │ 查询服务          │ 转发请求             │ 认证
   ▼                   ▼                      ▼
┌──────────────┐  ┌──────────────┐    ┌──────────────┐
│  服务注册中心 │  │   核心服务    │    │  热插拔服务   │
│  (Registry)  │  │   (Core)     │    │  (Plugins)   │
│              │  │              │    │              │
│ - 服务注册   │  │ - 用户管理   │    │ - 业务服务1  │
│ - 服务发现   │  │ - 租户管理   │    │ - 业务服务2  │
│ - 健康检查   │  │ - 认证授权   │    │ - 业务服务N  │
│ - 元数据管理 │  │ - 配置中心   │    │ - 第三方集成 │
└──────┬───────┘  └──────┬───────┘    └──────┬───────┘
       │                 │                   │
       └─────────────────┴───────────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │     数据持久层                 │
         │  - PostgreSQL (主数据库)      │
         │  - Redis (缓存/会话)          │
         └───────────────────────────────┘
```

## 核心组件

### 1. API 网关 (Gateway)

**职责:**
- 作为系统统一入口
- 动态路由请求到不同微服务
- 服务发现和负载均衡
- 请求/响应转换
- 错误处理和超时管理

**技术实现:**
- FastAPI 应用
- httpx 异步 HTTP 客户端
- 服务缓存机制（可升级为 Redis）

**路由规则:**
```
http://gateway/api/{service_name}/{path}
           ↓
http://{service_host}:{service_port}/{base_path}/{path}
```

**关键特性:**
- 服务缓存（30秒刷新）
- 自动服务发现
- 请求超时控制（30秒）
- 错误码映射

### 2. 服务注册中心 (Registry)

**职责:**
- 服务注册和注销
- 维护服务元数据
- 健康检查和心跳监控
- 服务版本管理

**数据模型:**
```python
Service:
  - id: 唯一标识
  - name: 服务名称
  - host: 主机地址
  - port: 端口号
  - version: 版本号
  - endpoints: 端点列表
  - metadata: 自定义元数据
  - last_heartbeat: 最后心跳时间
```

**API 端点:**
- `POST /api/registry/register` - 注册服务
- `POST /api/registry/heartbeat` - 发送心跳
- `POST /api/registry/deregister/{service_id}` - 注销服务
- `GET /api/registry/services` - 获取服务列表
- `GET /api/registry/services/{service_id}` - 获取服务详情

**健康检查机制:**
- 服务定期发送心跳（推荐30秒）
- 超过5分钟未心跳标记为不活跃
- 不活跃服务不出现在服务列表中

### 3. 核心服务 (Core)

**职责:**
- 用户认证和授权
- 租户管理
- 权限控制 (RBAC)
- 配置管理
- API 密钥管理

**功能模块:**

#### 认证模块
- JWT 令牌生成和验证
- 访问令牌（30分钟）
- 刷新令牌（7天）
- 密码加密（bcrypt）

#### 用户管理
- 用户注册、登录
- 用户角色管理
- 用户信息维护

#### 租户管理
- 多租户隔离
- 租户配置
- 租户服务启用/禁用

### 4. 热插拔服务 (Plugins)

**特点:**
- 独立开发和部署
- 自动注册到注册中心
- 定期心跳保持活跃
- 支持动态上下线

**生命周期:**
```
启动 → 注册 → 心跳 → 提供服务 → 注销 → 关闭
```

**标准化接口:**
```python
SERVICE_CONFIG = {
    "name": "服务名",
    "display_name": "显示名称",
    "version": "版本号",
    "host": "主机",
    "port": 端口,
    "endpoints": [端点列表],
    "metadata": {元数据},
}
```

## 数据流

### 服务注册流程

```
插件服务启动
    ↓
向注册中心发送注册请求
    ↓
注册中心保存服务信息
    ↓
返回注册成功
    ↓
插件服务开始定期心跳
```

### 请求处理流程

```
客户端请求 → API网关
    ↓
网关查询注册中心（获取服务信息）
    ↓
网关转发请求到目标服务
    ↓
目标服务处理请求
    ↓
返回响应 → 网关 → 客户端
```

### 认证流程

```
用户登录请求 → 核心服务
    ↓
验证用户名密码
    ↓
生成 JWT 令牌
    ↓
返回令牌给客户端
    ↓
客户端后续请求携带令牌
    ↓
网关/服务验证令牌
    ↓
允许访问
```

## 数据库设计

### 核心表结构

#### tenants (租户表)
- id: 租户ID
- name: 租户名称
- display_name: 显示名称
- config: 配置(JSON)
- enabled_services: 启用的服务列表
- created_at, updated_at

#### users (用户表)
- id: 用户ID
- tenant_id: 所属租户
- username: 用户名
- email: 邮箱
- hashed_password: 加密密码
- role: 角色（super_admin, tenant_admin, user）
- is_active: 是否激活
- created_at, updated_at, last_login

#### services (服务表)
- id: 服务ID
- name: 服务名称
- display_name: 显示名称
- version: 版本号
- host, port, base_path: 服务地址
- is_active: 是否活跃
- health_check_url: 健康检查URL
- last_heartbeat: 最后心跳时间
- metadata: 元数据(JSON)
- tags: 标签(JSON)
- created_at, updated_at

#### service_endpoints (服务端点表)
- id: 端点ID
- service_id: 所属服务
- path: 路径
- method: HTTP方法
- description: 描述
- required_roles: 需要的角色
- is_public: 是否公开
- rate_limit: 限流配置

#### api_keys (API密钥表)
- id: 密钥ID
- tenant_id: 所属租户
- name: 密钥名称
- key: 密钥值
- scopes: 权限范围
- expires_at: 过期时间
- last_used: 最后使用时间

## 扩展性设计

### 水平扩展

**网关扩展:**
```
负载均衡器
    ├── 网关实例 1
    ├── 网关实例 2
    └── 网关实例 N
```

**服务扩展:**
```
同一服务可以有多个实例
注册中心维护服务实例列表
网关自动负载均衡
```

### 垂直扩展

- 增加服务器资源
- 优化数据库查询
- 添加缓存层
- 使用连接池

## 安全性

### 1. 认证和授权
- JWT 令牌认证
- RBAC 角色权限控制
- API 密钥管理
- 令牌过期和刷新

### 2. 数据安全
- 密码 bcrypt 加密
- HTTPS 传输（生产环境）
- 数据库连接加密
- 敏感数据脱敏

### 3. 服务间通信
- API 密钥验证
- 服务白名单
- 请求签名
- 超时控制

## 监控和日志

### 监控指标
- 服务健康状态
- 请求响应时间
- 错误率
- 服务可用性

### 日志管理
- 结构化日志
- 集中式日志收集
- 日志级别控制
- 日志轮转

## 最佳实践

### 服务开发
1. 遵循 RESTful API 设计
2. 实现健康检查端点
3. 优雅关闭处理
4. 错误处理和重试机制
5. 完善的 API 文档

### 部署
1. 使用 Docker 容器化
2. 环境变量配置
3. 资源限制设置
4. 健康检查配置
5. 日志收集配置

### 运维
1. 定期备份数据库
2. 监控服务状态
3. 日志定期清理
4. 安全更新及时应用
5. 容量规划

## 性能优化

### 1. 缓存策略
- Redis 缓存热点数据
- 服务信息缓存
- 会话缓存
- 查询结果缓存

### 2. 数据库优化
- 索引优化
- 查询优化
- 连接池配置
- 读写分离

### 3. 应用优化
- 异步处理
- 批量操作
- 懒加载
- 资源池化

## 未来规划

### 短期
- [ ] 服务版本管理
- [ ] 灰度发布
- [ ] 限流和熔断
- [ ] 分布式追踪

### 中期
- [ ] 服务网格集成
- [ ] 自动扩缩容
- [ ] 多区域部署
- [ ] 数据备份恢复

### 长期
- [ ] AI 驱动的运维
- [ ] 自适应负载均衡
- [ ] 智能故障预测
- [ ] 完整的可观测性平台
